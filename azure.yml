trigger: none  # –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
schedules:
  - cron: "0 0 * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
    displayName: "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ç–æ–∫"
    branches:
      include:
        - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: PowerShell@2
    displayName: '–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ç–æ–∫'
    inputs:
      targetType: 'inline'
      script: |
  # === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
  $org = "your-org"          # –ò–º—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ Azure DevOps
  $project = "your-project"  # –ò–º—è –ø—Ä–æ–µ–∫—Ç–∞
  $token = "$(System.AccessToken)"  # –ü–æ–ª—É—á–µ–Ω–∏–µ PAT —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É Azure DevOps
  $daysOld = 21  # –ü–æ—Ä–æ–≥ "—É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö" –≤–µ—Ç–æ–∫ (–≤ –¥–Ω—è—Ö)

  # === –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã API ===
  $API_BASE_URL = "https://dev.azure.com/$org/$project/_apis/git/repositories"

  # === –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ===
  $headers = @{Authorization = "Basic " + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$token"))}
  $repos = Invoke-RestMethod -Uri "$API_BASE_URL?api-version=7.1-preview.1" -Headers $headers -Method Get

  # –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É 'mana-'
  $filteredRepos = $repos.value | Where-Object { $_.name -match "^mana-.*" }

  # === –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ç–æ–∫ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è ===
  foreach ($repo in $filteredRepos) {
      Write-Host "`nüîπ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: $($repo.webUrl)"

      # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤–µ—Ç–æ–∫
      $branchesUri = "$API_BASE_URL/$($repo.id)/refs?filter=heads/&api-version=7.1-preview.1"
      $branches = Invoke-RestMethod -Uri $branchesUri -Headers $headers -Method Get

      # –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
      $currentDate = Get-Date

      # –§–ª–∞–≥ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –µ—Å—Ç—å –ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –≤–µ—Ç–∫–∏
      $hasOldBranches = $false

      # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—É—é –≤–µ—Ç–∫—É
      foreach ($branch in $branches.value) {
          $branchName = $branch.name -replace 'refs/heads/', ''

          # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º master –∏ main
          if ($branchName -in @("master", "main")) {
              continue
          }

          # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∫–æ–º–º–∏—Ç–µ
          $commitUri = "$API_BASE_URL/$($repo.id)/commits?searchCriteria.itemVersion.version=$branchName&`$top=1&api-version=7.1-preview.1"
          $commitInfo = Invoke-RestMethod -Uri $commitUri -Headers $headers -Method Get

          # –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–º–º–∏—Ç–æ–≤, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
          if (-not $commitInfo.value) {
              Write-Host "    - $branchName (‚ö†Ô∏è –ù–µ—Ç –∫–æ–º–º–∏—Ç–æ–≤!)"
              continue
          }

          # –î–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞
          $lastCommitDate = Get-Date $commitInfo.value[0].author.date

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å–ª–∏ –∫–æ–º–º–∏—Ç –±—ã–ª —Å–¥–µ–ª–∞–Ω –±–æ–ª–µ–µ 30 –¥–Ω–µ–π –Ω–∞–∑–∞–¥
          $daysSinceLastCommit = ($currentDate - $lastCommitDate).Days
          if ($daysSinceLastCommit -ge $daysOld) {
              if (-not $hasOldBranches) {
                  Write-Host "  ‚ö†Ô∏è  –£—Å—Ç–∞—Ä–µ–≤—à–∏–µ –≤–µ—Ç–∫–∏ (—Å—É—â–µ—Å—Ç–≤—É—é—Ç $daysOld+ –¥–Ω–µ–π –±–µ–∑ –∫–æ–º–º–∏—Ç–æ–≤):"
                  $hasOldBranches = $true
              }
              Write-Host "    - $branchName (–ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $lastCommitDate, $daysSinceLastCommit –¥–Ω–µ–π –Ω–∞–∑–∞–¥)"
          }
      }

      # –ï—Å–ª–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ç–æ–∫ –Ω–µ—Ç
      if (-not $hasOldBranches) {
          Write-Host "  ‚úÖ –ù–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö –≤–µ—Ç–æ–∫"
      }
  }
