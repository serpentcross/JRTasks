trigger: none  # –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
schedules:
  - cron: "0 0 * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
    displayName: "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ç–æ–∫"
    branches:
      include:
        - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: PowerShell@2
    displayName: '–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ç–æ–∫'
    inputs:
      targetType: 'inline'
      script: |
        # === –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ===
        $org = "your-org"          # –ò–º—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –≤ Azure DevOps
        $project = "your-project"  # –ò–º—è –ø—Ä–æ–µ–∫—Ç–∞
        $token = "$(System.AccessToken)"  # –ü–æ–ª—É—á–µ–Ω–∏–µ PAT —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º—É Azure DevOps
        $branch = "refs/heads/main" # –û—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞ –¥–ª—è –ø–æ–ª–∏—Ç–∏–∫–∏

        # === –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ ===
        $headers = @{Authorization = "Basic " + [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$token"))}
        $repos = Invoke-RestMethod -Uri "https://dev.azure.com/$org/$project/_apis/git/repositories?api-version=7.1-preview.1" -Headers $headers -Method Get

        # –§–∏–ª—å—Ç—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –ø–æ –ø—Ä–µ—Ñ–∏–∫—Å—É 'mana-'
        $filteredRepos = $repos.value | Where-Object { $_.name -match "^mana-.*" }

        foreach ($repo in $filteredRepos) {
            Write-Host "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: $($repo.name)"
            
            # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–µ—Ç–∫–∏
            $branches = Invoke-RestMethod -Uri "https://dev.azure.com/$org/$project/_apis/git/repositories/$($repo.id)/refs?filter=heads/&api-version=7.1-preview.1" -Headers $headers -Method Get

            foreach ($branch in $branches.value) {
                # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—ã–µ –≤–µ—Ç–∫–∏
                if ($branch.name -eq "refs/heads/main" -or $branch.name -eq "refs/heads/develop") {
                    continue
                }

                # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∫–æ–º–º–∏—Ç–∞ –¥–ª—è –≤–µ—Ç–∫–∏
                $lastCommitDate = Invoke-RestMethod -Uri "https://dev.azure.com/$org/$project/_apis/git/repositories/$($repo.id)/commits?searchCriteria.itemVersion.version=${branch.name#refs/heads/}&$top=1&api-version=7.1-preview.1" -Headers $headers -Method Get
                $lastCommitDate = $lastCommitDate.value[0].author.date

                # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç –≤–µ—Ç–∫–∏ (–≤ –¥–Ω—è—Ö)
                $branchAge = (New-TimeSpan -Start (Get-Date $lastCommitDate) -End (Get-Date)).Days

                # –ï—Å–ª–∏ –≤–µ—Ç–∫–∞ —Å—Ç–∞—Ä—à–µ 21 –¥–Ω—è, —É–¥–∞–ª—è–µ–º –µ—ë
                if ($branchAge -gt 21) {
                    Write-Host "üóë –£–¥–∞–ª—è–µ–º –≤–µ—Ç–∫—É $($branch.name), –≤–æ–∑—Ä–∞—Å—Ç: $branchAge –¥–Ω–µ–π"
                    # –£–¥–∞–ª—è–µ–º –≤–µ—Ç–∫—É
                    Invoke-RestMethod -Uri "https://dev.azure.com/$org/$project/_apis/git/repositories/$($repo.id)/refs?filter=${branch.name#refs/heads/}&api-version=7.1-preview.1" -Headers $headers -Method Delete
                }
            }
        }
    displayName: "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ç–æ–∫ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º mana-"
