trigger: none  # –ó–∞–ø—É—Å–∫ —Ç–æ–ª—å–∫–æ –≤—Ä—É—á–Ω—É—é –∏–ª–∏ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é
schedules:
  - cron: "0 0 * * *"  # –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 00:00 UTC
    displayName: "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ç–æ–∫"
    branches:
      include:
        - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  - script: |
      echo "Fetching branches older than 21 days..."
      TOKEN="your-pat-token"
      ORG="your-org"
      PROJECT="your-project"

      # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤
      REPOS=$(curl -s -u :$TOKEN "https://dev.azure.com/$ORG/$PROJECT/_apis/git/repositories?api-version=7.1-preview.1" | jq -r '.value[].name')

      for REPO in $REPOS; do
        echo "Checking repository: $REPO"
        
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –≤–µ—Ç–∫–∏
        BRANCHES=$(curl -s -u :$TOKEN "https://dev.azure.com/$ORG/$PROJECT/_apis/git/repositories/$REPO/refs?filter=heads/&api-version=7.1-preview.1" | jq -r '.value[].name')

        for BRANCH in $BRANCHES; do
          if [[ "$BRANCH" != "refs/heads/main" && "$BRANCH" != "refs/heads/develop" ]]; then
            LAST_COMMIT_DATE=$(curl -s -u :$TOKEN "https://dev.azure.com/$ORG/$PROJECT/_apis/git/repositories/$REPO/commits?searchCriteria.itemVersion.version=${BRANCH#refs/heads/}&$top=1&api-version=7.1-preview.1" | jq -r '.value[0].author.date')
            
            BRANCH_AGE=$(($(date +%s) - $(date -d "$LAST_COMMIT_DATE" +%s)))
            BRANCH_AGE_DAYS=$((BRANCH_AGE / 86400))

            if [[ $BRANCH_AGE_DAYS -gt 21 ]]; then
              echo "üóë –£–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à—É—é –≤–µ—Ç–∫—É: $BRANCH (–≤–æ–∑—Ä–∞—Å—Ç: $BRANCH_AGE_DAYS –¥–Ω–µ–π)"
              curl -X DELETE -s -u :$TOKEN "https://dev.azure.com/$ORG/$PROJECT/_apis/git/repositories/$REPO/refs?filter=${BRANCH//\//%2F}&api-version=7.1-preview.1"
            fi
          fi
        done
      done
    displayName: "–£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ç–æ–∫"
